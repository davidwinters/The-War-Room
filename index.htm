<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>The War Room</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.17/themes/blitzer/jquery-ui.css">

    <style>
      body {
        padding-top: 80px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet">


    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">The War Room</a>
          <div class="nav-collapse">
            <!-- <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>
            </ul>-->
            <div class="btn-toolbar">
                <div class="btn-group pull-right">
                <a id="deleteall" class="btn btn-danger"> <i class="icon-trash icon-white"></i>Remove All Tanks</a>
                 <a id="deletedrawings" class="btn btn-danger"> <i class="icon-trash icon-white"></i>Clear Drawings</a>
                </div>
                <div id="map" class="btn-group">
                  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                  Select Map
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu">
                  <!-- dropdown menu links -->
                  <li><a title="map-abbey-1.jpg">Abbey</a></li>
                  <li><a title="map-arctic-region-1.jpg">Arctic Region</a></li>
                  <li><a title="map-cliff-1.jpg">Cliff</a></li>
                  <li><a title="map-el-halluf-1.jpg">El Halluf</a></li>
                  <li><a title="map-ensk-1.jpg">Ensk</a></li>
                  <li><a title="map-erlenberg-1.jpg">Erlenberg</a></li>
                  <li><a title="map-fishermans-bay-1.jpg">Fisherman's Bay</a></li>
                  <li><a title="map-fjords-1.jpg">Fjords</a></li>
                  <li><a title="map-himmelsdorf-1.jpg">Himmelsdof</a></li>
                  <li><a title="map-karelia-1.jpg">Karelia</a></li>
                  <li><a title="map-komarin-1.jpg">Komarin</a></li>
                  <li><a title="map-lakeville-1.jpg">Lakeville</a></li>
                  <li><a title="map-malinovka-1.jpg">Malinovka</a></li>
                  <li><a title="map-mines-1.jpg">Mines</a></li>
                  <li><a title="map-mountain-pass-1.jpg">Mountain Pass</a></li>
                  <li><a title="map-murovanka-1.jpg">Murovanka</a></li>
                  <li><a title="map-prokhorovka-1.jpg">Prokhorovka</a></li>
                  <li><a title="map-redshire-1.jpg">Redshire</a></li>
                  <li><a title="map-ruinberg-1.jpg">Ruinberg</a></li>
                  <li><a title="map-sand-river-1.jpg">Sand River</a></li>
                  <li><a title="map-siegfried-line-1.jpg">Siegfried Line</a></li>
                  <li><a title="map-steppes-1.jpg">Steppes</a></li>
                  <li><a title="map-westfield-1.jpg">Westfield</a></li>
                  </ul>
                </div>
               <div id="brushcolor" class="btn-group">
                  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                  Color
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu">
                  <!-- dropdown menu links -->
                  <div class='colorwrapper'>
                  <div class="colorwheel"></div>
                 
                   <input name="input_example" class="input-small input_example" type="text" />
                   </div>
                  </ul>
                </div>
                <div id="brushsize" class="btn-group">
                  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                  Size
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu">
                  <!-- dropdown menu links -->
                  <div class='colorwrapper'>
                  <div id="slider-vertical"></div>
                 
                   <input name="brush_size" class="input-small brushsize" type="text" />
                   </div>
                  </ul>
                </div>
                <div id="save" class="btn-group">
                <button class="btn">
                  <i class="icon-camera"></i> Save
                </button>
                </div>


            </div>


          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">
    <div class="row">
      
      <div id="menu" class="span3">
            
            <div class="tabbable well">
            <h3>Tank Depot</h3><em>drag available tanks onto map</em>
              <ul class="nav nav-tabs">
                <li class="active" ><a href="#1" data-toggle="tab" id="us">USA</a></li>
                <li><a href="#2" data-toggle="tab" id="ru">RUS</a></li>
                <li><a href="#3" data-toggle="tab" id="ge">GER</a></li>
                <li><a href="#4" data-toggle="tab" id="fr">FRA</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane active" id="1">
                  <p>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="t30"></div>T30</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="t92"></div>T92</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="patton"></div>Patton</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="t95"></div>T95</div>
                  </p>
                </div>
                <div class="tab-pane" id="2">
                  
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="is7"></div>IS-7</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="object261"></div>261</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="t54"></div>T-54</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="object704"></div>704</div>
                  
                </div>
              <div class="tab-pane" id="3">
                  
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="maus"></div>Maus</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="e100"></div>E100</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="gwtigere"></div>GWTigerE</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="e50"></div>E50</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="jtiger"></div>JTiger</div>
                  
                </div>
              <div class="tab-pane" id="4">
                  
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="amx50b"></div>AMX50B</div>
                                <div class="parent"><a class="close" data-dismiss="alert">&times;</a><div class="batchat"></div>Bat Chatillon</div>
                                
                  
                </div>
                    </div>
            
            </div>
            <div id="depot" class="well"></div>
       </div>  



      <div id="wrapper" class="span9">

        <canvas id="can" width="850" height="850"></canvas>
      
        <canvas id="canvasbuffer" width="850" height="850"></canvas>
      </div>

</div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://twitter.github.com/bootstrap/assets/js/jquery.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.js" type="text/javascript"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/raphael-1.3.1-min.js"></script>
    <script src="js/colorwheel.js"></script>



    <script>
   $(document).ready(function() {

      //tanks
      $('.parent').draggable({
        helper: "clone"
            

      });

      $("#wrapper").droppable({
        accept: ".parent",
        drop: function (event, ui){
          var offset = ui.offset;
          
          ui.draggable.clone().removeClass('parent').addClass('pawn').appendTo($(this)).css({'position': 'absolute', 'left': offset.left, 'top': offset.top}).draggable();
        }

      });
      //$('.parent').mousedown(function() {
        //var offset = $('canvas').offset();
        //$(this).clone().removeClass('parent').addClass('pawn').insertAfter('#menu').css({'position': 'absolute', 'left': 60+ offset.left, 'top': 120 + offset.top}).draggable();
        //$(this).clone();
        //$(this).removeClass('parent').addClass('pawn');
   
      //});

      //remove tanks
      $('#deleteall').click(function() {
        $('.pawn').remove();
       });
      
      
      var map_name;
      $('#map ul a').click(function() {
        var map = 'url(img/maps/' + $(this).attr("title") + ')';
        $('#wrapper').css('background-image', map );
        map_name = $(this).attr("title")
       // $('#map a')
       });

      

      $('button').button();

      //drawing
        var draw= false;
        
        var canvas = document.getElementById("can");
        var ctx = canvas.getContext("2d");
        var color = $(".input_example").css('background-color');
        ctx.strokeStyle = color;
        
        //set it true on mousedown
        $("canvas").mousedown(function(e){draw=true;
            draw=true;
              ctx.save();
              x = e.pageX-this.offsetLeft;
              y = e.pageY-this.offsetTop; 
            
        });

        //reset it on mouseup
        $("canvas").mouseup(function(){draw=false;});

        $("canvas").mousemove(function(e) {
            
            if(draw){
              var offset = $('canvas').offset();
              
              if ($('.brushsize').val()){
                var brushSize = $('.brushsize').val();
              }else { var brushSize = 5;}
                    ctx.lineWidth = brushSize;
                    ctx.lineCap = "round";
                    ctx.beginPath();
                    ctx.moveTo(e.pageX-this.offsetLeft,e.pageY-this.offsetTop);
                    ctx.lineTo(x,y);
                    ctx.stroke();
                    ctx.closePath();
                    x = e.pageX-this.offsetLeft;
                    y = e.pageY-this.offsetTop;  

            }    
       });
        //eraser
        $('#eraser a').click(function() {
          ctx.strokeStyle = 'rgba(0,0,0,0)';
          alert('lol');
         });

        //delete drawings
        $("#deletedrawings").click(function(){
                 // Store the current transformation matrix

                  ctx.save();

                  // Use the identity matrix while clearing the canvas
                  ctx.setTransform(1, 0, 0, 1, 0, 0);
                  ctx.clearRect(0, 0, canvas.width, canvas.height);

                  // Restore the transform
                  ctx.restore();
        });

        
//colorwheel stuff
        
        Raphael.colorwheel($(".colorwheel")[0], 150).color("#F00").onchange(function(c){$(".input_example").css("background-color",c.hex);ctx.strokeStyle = c.hex;});

            $( "#slider-vertical" ).slider({
                orientation: "horizontal",
                range: "min",
                min: 0,
                max: 20,
                value: 5,
                  slide: function( event, ui ) {
                    $( ".brushsize" ).val( ui.value );
                  }
            });
            $( ".brushsize" ).val( $( "#slider-vertical" ).slider( "value" ) );




//save canvas
        function removepx(mystring){
          var newstring = new String(mystring);
          var pxstart = newstring.search('p');
            if (newstring.search('-') > -1){
              var start = 1;
            }else { var start = 0;}

          var cleanstring = newstring.slice(start, pxstart);
          return cleanstring;
        }

        $('#save').click(function() {
            var can2 = document.getElementById('canvasbuffer');
            var ctx2 = can2.getContext('2d');
            ctx2.font = "13px Arial";
            ctx2.fillStyle ="#ffffff";


                  //first clear the canvas
                  ctx2.save();
                  ctx2.setTransform(1, 0, 0, 1, 0, 0);
                  ctx2.clearRect(0, 0, canvas.width, canvas.height);
                  ctx2.restore();
              
              bg_img_loc = $('#wrapper').css('background-image');
              img_split_str = bg_img_loc.split('"');
              
              var img_bg = new Image();
              img_bg.src = img_split_str[1]
                
              
              ctx2.drawImage(img_bg, 0, 0, 850, 850);

              $('.pawn div').each(function(index) {
                  var offset2 = $(this).offset();
                  var canvasoffset = $("#can").offset();

                  posx =  offset2.left - canvasoffset.left;
                  posy = offset2.top -canvasoffset.top;

                  var imgstring = new String($(this).css('background-image'));
                  
                    var imgh = removepx($(this).css('height'));
                    var imgw = removepx($(this).css('width'));

                    var crop = new String($(this).css('background-position'));
                    var crop_split;
                    
                    crop_split = crop.split(' ');
                     
                    var cropx = removepx(crop_split[0]);
                    var cropy = removepx(crop_split[1]);

                    var split_str, new_str;
                    split_str = imgstring.split('"');
                  

                    var img_loc = new Image();
                    img_loc.src = split_str[1]
 
                  ctx2.drawImage(img_loc, cropx, cropy, imgw, imgh, posx, posy, imgw, imgh);
                  var texty = parseInt(posy) + parseInt(imgh) + 10; 
                  var content = $(this).parent().text();
                  ctx2.fillText(content,posx,texty);
                  

                });
              


            ctx2.drawImage(canvas, 0, 0);
            try {
                var img = can2.toDataURL('image/jpeg', 0.9).split(',')[1];
            } catch(e) {
                var img = can2.toDataURL().split(',')[1];
            }
            // open the popup in the click handler so it will not be blocked
            var w = window.open();
            w.document.write('Uploading...');
            // upload to imgur using jquery/CORS
            // https://developer.mozilla.org/En/HTTP_access_control
            $.ajax({
                url: 'http://api.imgur.com/2/upload.json',
                type: 'POST',
                data: {
                    type: 'base64',
                    // get your key here, quick and fast http://imgur.com/register/api_anon
                    key: '5d329282c17e4e1a1a7d32663fd55cf9',
                    name: map_name,
                    title: map_name,
                    caption: map_name,
                    image: img
                },
                dataType: 'json'
            }).success(function(data) {
                w.location.href = data['upload']['links']['imgur_page'];
            }).error(function() {
                alert('Could not reach api.imgur.com. Sorry :(');
                w.close();
            });


            
        });

     });
  </script>

  </body>
</html>
